openapi: 3.0.3
info:
  title: Kamini SSH Certificate Authority API
  version: 0.1.0
  description: |
    Kamini is a pluggable SSH CA that issues short-lived user certificates after modern identity authentication.
    This spec describes the minimal REST API for the MVP server.
servers:
  - url: https://localhost:8443
    description: Local development server
paths:
  /v1/certs/user:
    post:
      summary: Issue a short-lived SSH user certificate
      description: |
        Request a signed SSH user certificate. Requires a valid OIDC bearer token.
      operationId: issueUserCert
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                public_key:
                  type: string
                  example: "ssh-ed25519 AAAAC3..."
                  description: SSH public key to sign
                ttl_seconds:
                  type: integer
                  example: 3600
                  description: Requested certificate lifetime in seconds
              required:
                - public_key
                - ttl_seconds
      responses:
        '200':
          description: Certificate issued
          content:
            application/json:
              schema:
                type: object
                properties:
                  certificate_authorized_key:
                    type: string
                    example: "ssh-ed25519-cert-v01@openssh.com AAAA..."
                  serial:
                    type: integer
                    example: 123456
                  not_before:
                    type: integer
                    example: 1699999999
                  not_after:
                    type: integer
                    example: 1700003599
                required:
                  - certificate_authorized_key
                  - serial
                  - not_before
                  - not_after
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
        '409':
          description: Conflict (e.g., TTL exceeds max)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
  /v1/certs/host:
    post:
      summary: Issue a short-lived SSH host certificate
      description: |
        This endpoint is reserved for future host certificate issuance.
      operationId: issueHostCert
      security:
        - bearerAuth: []
      responses:
        '501':
          description: Not implemented
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
  /v1/ca/user:
    get:
      summary: Get SSH User CA public key
      description: |
        Fetch the SSH User CA public key used to sign user certificates. Clients should retrieve and pin this key after login (TOFU pinning).
      operationId: getUserCAKey
      security:
        - bearerAuth: []
      responses:
        '200':
          description: SSH User CA public key in OpenSSH authorized_keys format
          content:
            text/plain:
              schema:
                type: string
                example: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAICv5... kamini-ca@domain"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
  /v1/ca/host:
    get:
      summary: Get SSH Host CA public key
      description: |
        This endpoint is reserved for future use and currently always returns "Not implemented".
      operationId: getHostCAKey
      security:
        - bearerAuth: []
      responses:
        '501':
          description: Not implemented
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
  /v1/healthz:
    get:
      summary: Health check
      description: Probe endpoint for readiness/liveness checks.
      operationId: healthz
      responses:
        '200':
          description: Healthy
          content:
            text/plain:
              schema:
                type: string
                example: "ok"
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Use an OIDC-issued JWT access token in the Authorization header:
        'Authorization: Bearer <token>'.
        The token must be obtained by the client from the configured identity provider (e.g., Entra ID, Okta, etc.).
        Required for all endpoints except /v1/healthz.
  schemas:
    ErrorEnvelope:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              example: "AUTH_INVALID_TOKEN"
            message:
              type: string
              example: "Signature/claims invalid"
            retryable:
              type: boolean
              example: false
            trace_id:
              type: string
              example: "abcd-1234"
            details:
              type: object
              additionalProperties: true
      required:
        - error
